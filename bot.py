from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, ContextTypes, filters
import os
import re

TOKEN = os.environ["BOT_TOKEN"]

# --- Ğ­ĞºÑ€Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¿ĞµÑ†ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ MarkdownV2 ---
def escape(text: str) -> str:
    escape_chars = r"\_*[]()~`>#+-=|{}.!"
    return ''.join(f"\\{c}" if c in escape_chars else c for c in text)

async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.text:
        return

    actions = {
        "/Ğ¾Ğ±Ğ½ÑÑ‚ÑŒ": "Ğ¾Ğ±Ğ½ÑĞ»Ğ°",
        "/Ñ‡Ğ¼Ğ¾ĞºĞ½ÑƒÑ‚ÑŒ": "Ñ‡Ğ¼Ğ¾ĞºĞ½ÑƒĞ»Ğ°",
        "/Ğ¿Ğ¾Ñ†ĞµĞ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ": "Ğ¿Ğ¾Ñ†ĞµĞ»Ğ¾Ğ²Ğ°Ğ»Ğ°",
        "/Ğ¿Ğ¾Ğ³Ğ»Ğ°Ğ´Ğ¸Ñ‚ÑŒ": "Ğ¿Ğ¾Ğ³Ğ»Ğ°Ğ´Ğ¸Ğ»Ğ°",
        "/ÑˆĞ»ĞµĞ¿Ğ½ÑƒÑ‚ÑŒ": "ÑˆĞ»Ñ‘Ğ¿Ğ½ÑƒĞ»Ğ°",
        "/ÑƒĞ´Ğ°Ñ€Ğ¸Ñ‚ÑŒ": "ÑƒĞ´Ğ°Ñ€Ğ¸Ğ»Ğ°",
        "/Ğ¿Ğ¾Ñ‰ĞµÑ‡Ğ¸Ğ½Ğ°": "Ğ´Ğ°Ğ»Ğ° Ğ¿Ğ¾Ñ‰Ñ‘Ñ‡Ğ¸Ğ½Ñƒ",
        "/Ğ»Ğ¸Ğ·Ğ½ÑƒÑ‚ÑŒ": "Ğ»Ğ¸Ğ·Ğ½ÑƒĞ»Ğ°",
        "/Ğ¿Ğ¾Ñ…Ğ²Ğ°Ğ»Ğ¸Ñ‚ÑŒ": "Ğ¿Ğ¾Ñ…Ğ²Ğ°Ğ»Ğ¸Ğ»Ğ°",
        "/ĞºÑƒÑÑŒ": "ĞºÑƒÑÑŒĞ½ÑƒĞ»Ğ°",
        "/Ğ¿Ñ€Ğ¸Ğ¶Ğ°Ñ‚ÑŒ": "Ğ¿Ñ€Ğ¸Ğ¶Ğ°Ğ»Ğ° Ğº ÑÑ‚ĞµĞ½Ğµ",
        "/ÑĞµÑÑ‚ÑŒĞ½Ğ°Ğ»Ğ¸Ñ†Ğ¾": "ÑĞµĞ»Ğ° Ğ½Ğ° Ğ»Ğ¸Ñ†Ğ¾",
        "/ÑĞµÑÑ‚ÑŒĞ½Ğ°ĞºĞ¾Ğ»ĞµĞ½Ğ¸": "ÑĞµĞ»Ğ° Ğ½Ğ° ĞºĞ¾Ğ»ĞµĞ½Ğ¸",
        "/Ğ¾Ğ±Ğ»Ğ°Ğ¿Ğ°Ñ‚ÑŒ": "Ğ¾Ğ±Ğ»Ğ°Ğ¿Ğ°Ğ»Ğ°",
        "/Ñ‚Ñ€Ğ°Ñ…Ğ½ÑƒÑ‚ÑŒ": "Ñ‚Ñ€Ğ°Ñ…Ğ½ÑƒĞ»Ğ°",
        "/Ğ²Ñ‹ĞµĞ±Ğ°Ñ‚ÑŒ": "Ğ²Ñ‹ĞµĞ±Ğ°Ğ»Ğ°",
        "/ÑĞµĞºÑĞ¸Ñ‚ÑŒ": "Ğ½ĞµĞ¶Ğ½Ğ¾ ÑĞµĞºÑĞ¸Ñ‚ Ñ",
        "/Ğ¾Ñ‚Ğ»Ğ¸Ğ·Ğ°Ñ‚ÑŒ": "Ğ¾Ñ‚Ğ»Ğ¸Ğ·Ğ°Ğ»Ğ°",
        "/Ğ¾Ñ‚ÑÑ‚Ñ€Ğ°Ğ¿Ğ¾Ğ½Ğ¸Ñ‚ÑŒ": "Ğ¾Ñ‚ÑÑ‚Ñ€Ğ°Ğ¿Ğ¾Ğ½Ğ¸Ğ»Ğ°",
        "/Ğ½Ğ¾Ğ¶Ğ½Ğ¸Ñ†Ñ‹": "Ğ¿Ğ¾Ñ‚Ñ‘Ñ€Ğ»Ğ°ÑÑŒ Ğ¿Ğ¸ÑĞµĞ¹ Ñ",
        "/Ğ¿Ğ½ÑƒÑ‚ÑŒ": "Ğ¿Ğ½ÑƒĞ»Ğ°",
        "/Ğ¿Ğ¾ĞºĞ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ": "Ğ¿Ğ¾ĞºĞ¾Ñ€Ğ¼Ğ¸Ğ»Ğ°",
        "/Ğ¿Ñ€Ğ¸Ğ¿Ğ¾Ğ´Ğ½ÑÑ‚ÑŒ": "Ğ¿Ñ€Ğ¸Ğ¿Ğ¾Ğ´Ğ½ÑĞ»Ğ°",
        "/ÑƒĞºÑƒÑĞ¸Ñ‚ÑŒ": "ÑƒĞºÑƒÑĞ¸Ğ»Ğ°",
        "/ÑĞ¾Ğ¶Ñ€Ğ°Ñ‚ÑŒ": "ÑĞ¾Ğ¶Ñ€Ğ°Ğ»Ğ°",
        "/Ğ¾Ñ‚Ğ¾Ğ´Ñ€Ğ°Ñ‚ÑŒ": "Ğ¾Ñ‚Ğ¾Ğ´Ñ€Ğ°Ğ»Ğ°",
        "/Ğ¼Ğ¾Ñ€Ğ´Ğ°Ñ‚ÑŒ": "Ğ¼Ğ¾Ñ€Ğ´Ğ°Ğ½ÑƒĞ»Ğ°",
        "/Ğ·Ğ°Ğ¿ĞµÑ€ĞµÑ‚ÑŒ": "Ğ·Ğ°Ğ¿ĞµÑ€Ğ»Ğ° Ğ² Ğ¿Ğ¾Ğ´Ğ²Ğ°Ğ»Ğµ",
        "/Ğ·Ğ°Ğ±ÑƒĞ»Ğ»Ğ¸Ñ‚ÑŒ": "Ğ·Ğ°Ğ±ÑƒĞ»Ğ»Ğ¸Ğ»Ğ°",
        "/Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ñ‡Ğ¸Ñ‚ÑŒ": "Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ñ‡Ğ¸Ğ»Ğ°",
        "/Ğ¿Ñ€Ğ¾Ğ±ĞºĞ°": "Ğ²ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ±ĞºÑƒ Ğ²",
        "/Ğ¿Ğ¾Ğ¿Ğ¸ÑĞ¸Ñ‚ÑŒ": "Ğ¿Ğ¾Ğ¿Ğ¸ÑĞ¸Ğ»Ğ° Ğ²Ğ¼ĞµÑÑ‚Ğµ Ñ",
        "/Ğ¿Ğ¾ĞºĞ°ĞºĞ°Ñ‚ÑŒ": "Ğ¿Ğ¾ĞºĞ°ĞºĞ°Ğ»Ğ° Ğ²Ğ¼ĞµÑÑ‚Ğµ Ñ",
        "/Ğ²Ğ¸Ğ±Ñ€Ğ°Ñ‚Ğ¾Ñ€": "Ğ²ĞºĞ»ÑÑ‡Ğ¸Ğ»Ğ° Ğ´Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ±Ñ€Ğ°Ñ‚Ğ¾Ñ€",
        "/Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ½Ğ°Ñ‚ÑŒ": "Ğ¿Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ»Ğ° Ğ½Ğ° ÑƒÑˆĞºĞ¾",
        "/Ğ¿Ğ¸ÑĞºĞ°": "Ğ´Ğ°Ğ»Ğ° Ğ¿Ğ¸ÑĞºÑƒ Ñ€Ğ¸ÑĞ°",
        "/Ğ½ĞµÑ‚Ğ¿Ğ¸ÑĞºĞ°": "Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ»Ğ° Ğ¿Ğ¸ÑĞºÑƒ Ñ€Ğ¸ÑĞ°",
        "/ÑƒĞ±Ğ°ÑĞºĞ°Ñ‚ÑŒ": "ÑƒĞ±Ğ°ÑĞºĞ°Ğ»Ğ°",
        "/Ğ½Ğ°Ğ³Ğ½ÑƒÑ‚ÑŒ": "Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ° Ñ€Ğ°ĞºĞ¾Ğ¼",
        "/Ğ¾Ñ‚ÑˆĞ»ĞµĞ¿Ğ°Ñ‚ÑŒ": "Ğ¾Ñ‚ÑˆĞ»Ñ‘Ğ¿Ğ°Ğ»Ğ°",
        "/Ğ¾Ñ‚ÑĞ¾ÑĞ°Ñ‚ÑŒ": "Ğ¾Ñ‚ÑĞ¾ÑĞ°Ğ»Ğ°",
        "/ÑĞ²ÑĞ·Ğ°Ñ‚ÑŒ": "ÑĞ²ÑĞ·Ğ°Ğ»Ğ°",
        "/Ğ¾Ñ‚Ğ¼ÑƒĞ´Ğ¾Ñ…Ğ°Ñ‚ÑŒ": "Ğ¾Ñ‚Ğ¼ÑƒĞ´Ğ¾Ñ…Ğ°Ğ»Ğ°",
        "/Ğ¾Ñ‚Ğ¿Ğ¸Ğ·Ğ´Ğ¸Ñ‚ÑŒ": "Ğ¾Ñ‚Ğ¿Ğ¸Ğ·Ğ´Ğ¸Ğ»Ğ°",
        "/ÑÑ€Ğ°Ñ‡": "ÑƒÑÑ‚Ñ€Ğ¾Ğ¸Ğ»Ğ° ÑÑ€Ğ°Ñ‡ Ñ",
        "/Ğ¼ĞµÑ‚": "Ğ´Ğ°Ğ»Ğ° Ğ¿Ğ°ĞºĞµÑ‚Ğ¸Ğº Ğ¼ĞµÑ‚Ğ°Ğ¼Ñ„ĞµÑ‚Ğ°Ğ¼Ğ¸Ğ½Ğ°",
        "/Ğ¼ĞµÑ„": "Ğ´Ğ°Ğ»Ğ° Ğ¿Ğ°ĞºĞµÑ‚Ğ¸Ğº Ğ¼ĞµÑ„ĞµĞ´Ñ€Ğ¾Ğ½Ğ°",
        "/ĞºĞ¾ĞºÑ": "Ğ´Ğ°Ğ»Ğ° Ğ¿Ğ°ĞºĞµÑ‚Ğ¸Ğº ĞºĞ¾ĞºĞ°Ğ¸Ğ½Ğ°",
        "/Ğ³ĞµÑ€Ñ‹Ñ‡": "Ğ´Ğ°Ğ»Ğ° Ğ¿Ğ°ĞºĞµÑ‚Ğ¸Ğº Ğ³ĞµÑ€Ğ¾Ğ¸Ğ½Ğ°",
        "/Ğ¿Ğ¾Ğ¶Ğ°Ğ¼ĞºĞ°Ñ‚ÑŒ": "Ğ¿Ğ¾Ğ¶Ğ°Ğ¼ĞºĞ°Ğ»Ğ°",
        "/ÑĞ¸ÑÑ": "Ğ¿Ğ¾Ğ¼Ğ°Ñ†Ğ°Ğ»Ğ° Ğ·Ğ° ÑĞ¸ÑÑ",
        "/Ğ¿Ğ¾Ğ¿Ğ°": "Ğ¿Ğ¾Ğ¼ÑĞ»Ğ° Ğ¶Ğ¾Ğ¿Ñƒ",
        "/Ñ„Ğ¸ÑÑ‚Ğ¸Ğ½Ğ³": "Ğ·Ğ°Ğ¿Ğ¸Ñ…Ğ½ÑƒĞ»Ğ° Ñ€ÑƒĞºÑƒ Ğ¿Ğ¾ ÑĞ°Ğ¼Ñ‹Ğ¹ Ğ»Ğ¾ĞºĞ¾Ñ‚ÑŒ Ğ² Ğ¶Ğ¾Ğ¿Ñƒ",
        "/Ğ²Ğ¾ÑĞºÑ€ĞµÑĞ¸Ñ‚ÑŒ": "Ğ²Ğ¾ÑĞºÑ€ĞµÑĞ¸Ğ»Ğ°",
        "/Ğ¾Ğ±Ğ¾ÑÑĞ°Ñ‚ÑŒ": "Ğ¾Ğ±Ğ¾ÑÑĞ°Ğ»Ğ°",
        "/Ğ¾Ğ±Ğ¾ÑÑ€Ğ°Ñ‚ÑŒ": "Ğ¾Ğ±Ğ¾ÑÑ€Ğ°Ğ»Ğ°",
        "/Ğ¿Ğ¾Ğ½ÑÑ…Ğ°Ñ‚ÑŒ": "Ğ¿Ğ¾Ğ½ÑÑ…Ğ°Ğ»Ğ°",
    }
    
    self_actions = {
        "/ÑƒĞ¼ĞµÑ€ĞµÑ‚ÑŒ": "Ğ²Ğ½ĞµĞ·Ğ°Ğ¿Ğ½Ğ¾ ÑƒĞ¼ĞµÑ€Ğ»Ğ°",
        "/ÑÑƒĞ¸Ñ†Ğ¸Ğ´": "ÑĞ¾Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ° ÑÑƒĞ¸Ñ†Ğ¸Ğ´",
        "/Ğ·Ğ°ÑĞ½ÑƒÑ‚ÑŒ": "ÑƒÑĞ½ÑƒĞ»Ğ°",
        "/ÑƒĞ»ĞµÑ‚ĞµÑ‚ÑŒ": "ÑƒĞ»ĞµÑ‚ĞµĞ»Ğ° Ğ² ĞºĞ¾ÑĞ¼Ğ¾Ñ",
        "/Ğ¾ĞºĞ½Ğ¾": "Ğ²Ñ‹ÑˆĞ»Ğ° Ğ² Ğ¾ĞºĞ½Ğ¾",
        "/ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ÑŒ": "ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ°",
        "/Ğ·Ğ¸Ğ³Ğ°": "Ğ¿Ğ»Ğ¾Ñ‚Ğ½Ğ¾ Ğ¿Ğ¾Ñ‚ÑĞ½ÑƒĞ»Ğ°ÑÑŒ Ğº ÑĞ¾Ğ»Ğ½Ñ†Ñƒ",
    }

    text = update.message.text.strip()
    command = text.split()[0]

     # ĞšĞ»Ğ¸ĞºĞ°Ğ±ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»Ñ
    sender_name = escape(update.effective_user.first_name)
    sender = f"[{sender_name}](tg://user?id={update.effective_user.id})"

    
    # Ğ¡Ğ°Ğ¼Ğ¾-Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
    if command in self_actions:
        action_text = self_actions[command]
        await update.message.reply_text(
            f"{sender} {action_text}",
            parse_mode="MarkdownV2"
        )
        return
    
 # --- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ñ Ñ†ĞµĞ»ÑŒÑ ---
    if command in actions:
        action_verb = actions[command]

        # 1. Ğ˜Ñ‰ĞµĞ¼ @username
        mentioned_users = re.findall(r'@[\w\d_]+', text)
        if mentioned_users:
            target = mentioned_users[0]  # Telegram ÑĞ°Ğ¼ ÑĞ´ĞµĞ»Ğ°ĞµÑ‚ ĞºĞ»Ğ¸ĞºĞ°Ğ±ĞµĞ»ÑŒĞ½Ñ‹Ğ¼
        elif update.message.reply_to_message:
            target_user = update.message.reply_to_message.from_user
            target_name = escape(target_user.first_name)
            target = f"[{target_name}](tg://user?id={target_user.id})"
        elif len(text.split()) > 1:
            target = escape(" ".join(text.split()[1:]))
        else:
            target = "Ğ²ÑĞµÑ… ğŸ«‚"

        await update.message.reply_text(
            f"{sender} {action_verb} {target}",
            parse_mode="MarkdownV2"
        )


app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, message_handler))

app.run_polling()
